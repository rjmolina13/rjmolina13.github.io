<!DOCTYPE html>
<html lang="en">
    <head>
        <script>
            (function () {
                const key = 'qw_theme';
                const stored = localStorage.getItem(key) || 'auto';
                const sys = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                const eff = stored === 'auto' ? sys : stored;

                const d = document.documentElement;
                d.dataset.theme = eff;                 // if you use [data-theme="dark"] in CSS
                d.classList.remove('theme-light','theme-dark');
                d.classList.add(eff === 'dark' ? 'theme-dark' : 'theme-light');
            })();
        </script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Settings - QuizWhiz</title>
        <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="alternate icon" href="../favicon.svg">

        <!-- Font Awesome -->
        <link
        rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <!-- CSS Files -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/footer.css">
    
    <!-- Settings Page Specific Styles -->
    <style>
        /* CSS-based auth guards to maintain grid structure */
        .auth-required {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            transition: opacity 0.3s ease;
            position: relative;
        }

        .auth-required.auth-loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .auth-required.auth-loading::after {
            content: "Loading authentication...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg, #fff);
            padding: 1rem 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color, #ddd);
            color: var(--text-secondary, #666);
            font-size: 0.9rem;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
    <!-- Fallback auth visibility without Alpine.js -->
    <style>
        .auth-required.auth-hidden { display: none !important; }
        .auth-required.auth-visible { display: grid; }
    </style>
    
    <!-- Local Storage Authentication - No external services needed -->
    </head>
    <body>
        <div
            class="app-container">
            <!-- Navigation Header -->
            <div id="navbar-container"></div>

            <!-- Main Content -->
            <main class="main-content">
                <section id="settings" class="content-section active">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-cog"></i>
                            Settings & Data Management</h2>
                    </div>

                    <div class="settings-container">
                        <div class="settings-group">
                            <h3>
                                <i class="fas fa-palette"></i>
                                Appearance</h3>
                            <div class="setting-item">
                                <label for="theme-select">Theme:</label>
                                <div class="custom-select" id="theme-selector-container">
                                    <button class="select-button" type="button" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="selected-value">
                                            <i class="fas fa-adjust"></i>
                                            Auto
                                        </span>
                                        <i class="fas fa-chevron-down arrow"></i>
                                    </button>
                                    <ul class="select-dropdown hidden" role="listbox">
                                        <li class="select-option" data-value="light" role="option">
                                            <i class="fas fa-sun"></i>
                                            Light
                                        </li>
                                        <li class="select-option" data-value="dark" role="option">
                                            <i class="fas fa-moon"></i>
                                            Dark
                                        </li>
                                        <li class="select-option selected" data-value="auto" role="option">
                                            <i class="fas fa-adjust"></i>
                                            Auto
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="setting-item">
                                <label for="animation-toggle">Animations:</label>
                                <div class="custom-checkbox" id="animation-toggle-container">
                                    <input type="checkbox" id="animation-toggle" checked>
                                    <div class="custom-checkbox-box"></div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <h3>
                                <i class="fas fa-brain"></i>
                                Study Settings</h3>
                            <div class="setting-item">
                                <label for="auto-flip">Auto-flip cards (seconds):</label>
                                <input type="number" id="auto-flip" min="0" max="30" value="0" placeholder="0 = disabled">
                            </div>
                            <div class="setting-item">
                                <label for="shuffle-default">Shuffle by default:</label>
                                <div class="custom-checkbox" id="shuffle-default-container">
                                    <input type="checkbox" id="shuffle-default">
                                    <div class="custom-checkbox-box"></div>
                                </div>
                            </div>
                            <div class="setting-item">
                                <label for="difficulty-feature">Difficulty feature:</label>
                                <div class="custom-checkbox" id="difficulty-feature-container">
                                    <input type="checkbox" id="difficulty-feature">
                                    <div class="custom-checkbox-box"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Management Section -->
                        <div class="settings-group auth-required auth-hidden" id="data-management-section">
                            <h3>
                                <i class="fas fa-database"></i>
                                Data Management</h3>

                            <!-- Import Data -->
                            <div class="data-subsection">
                                <h4>
                                    <i class="fas fa-upload"></i>
                                    Import Data</h4>
                                <p class="import-description">
                                    Import flashcards and data from various formats. JSON exports from QuizWhiz will restore your complete backup including all settings and preferences.
                                </p>
                                <div class="file-upload-area" id="settings-file-upload-area">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <p class="upload-text">Drag and drop files here or click to browse</p>
                                        <small class="supported-formats">Supports JSON files for complete backup restoration</small>
                                        <div class="file-info" id="selected-file-info" style="display: none;">
                                            <div class="file-details">
                                                <span class="file-name"></span>
                                                <span class="file-size"></span>
                                                <span class="file-status"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="drag-overlay" id="drag-overlay" style="display: none;">
                                        <div class="drag-content">
                                            <i class="fas fa-download drag-icon"></i>
                                            <p class="drag-text">Drop your JSON file here</p>
                                        </div>
                                    </div>
                                    <div class="upload-progress" id="upload-progress" style="display: none;">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="progress-fill"></div>
                                        </div>
                                        <span class="progress-text" id="progress-text">Analyzing file...</span>
                                    </div>
                                    <div class="analysis-results" id="analysis-results" style="display: none;">
                                        <div class="analysis-summary">
                                            <h5><i class="fas fa-chart-bar"></i> File Analysis</h5>
                                            <div class="analysis-stats" id="analysis-stats"></div>
                                        </div>
                                        <div class="analysis-actions">
                                            <button type="button" class="btn btn-primary" id="proceed-import-btn">
                                                <i class="fas fa-arrow-right"></i>
                                                Proceed with Import
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="cancel-import-btn">
                                                <i class="fas fa-times"></i>
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="file" id="settings-file-input" accept=".json" style="display: none;">
                                <div class="file-format-help">
                                    <h4>Supported Formats:</h4>
                                    <ul>
                                        <li>
                                            <strong>JSON (Complete Backup):</strong>
                                            Restores all data including flashcards, quizzes, settings, statistics, and user profile</li>
                                        <li>
                                            <strong>JSON (Legacy/Partial):</strong>
                                            {"flashcards": [{"question": "Q", "answer": "A", "deck": "Deck", "difficulty": "easy"}]}</li>
                                        <li>
                                            <strong>CSV:</strong>
                                            question,answer,deck,difficulty</li>
                                        <li>
                                            <strong>TXT:</strong>
                                            Question|Answer|Deck|Difficulty (one per line)</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Export Data -->
                            <div class="data-subsection">
                                <h4>
                                    <i class="fas fa-download"></i>
                                    Export Data</h4>
                                <p class="export-description">
                                    Export your complete QuizWhiz data including flashcards, quizzes, settings, statistics, user profile, and all preferences.
                                </p>
                                <div class="export-actions">
                                    <button type="button" class="btn btn-primary" id="export-json-btn">
                                        <i class="fas fa-download"></i>
                                        Export Complete Backup (JSON)
                                    </button>
                                    <button type="button" class="btn btn-primary" id="export-xml-btn">
                                        <i class="fas fa-download"></i>
                                        Export Complete Backup (XML)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Storage Information Section -->
                        <div class="settings-group auth-required auth-hidden">
                            <h3>
                                <i class="fas fa-database"></i>
                                Storage Information</h3>
                            <div class="storage-card">
                                <div class="storage-stat">
                                    <i class="fas fa-hdd"></i>
                                    <div class="stat-details">
                                        <span class="stat-label">Storage Used:</span>
                                        <span class="stat-value" id="storage-used">0 KB</span>
                                    </div>
                                </div>
                                <div class="storage-stat">
                                    <i class="fas fa-layer-group"></i>
                                    <div class="stat-details">
                                        <span class="stat-label">Total Flashcards:</span>
                                        <span class="stat-value" id="total-flashcards-count">0</span>
                                    </div>
                                </div>
                                <div class="storage-stat">
                                    <i class="fas fa-question-circle"></i>
                                    <div class="stat-details">
                                        <span class="stat-label">Total Quizzes:</span>
                                        <span class="stat-value" id="total-quizzes-count">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="danger-zone">
                                <h4>
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Danger Zone</h4>
                                <div class="data-actions">
                                    <button type="button" class="btn btn-danger" id="clear-all-data-btn">
                                        <i class="fas fa-trash"></i>
                                        Clear All Data
                                    </button>
                                </div>
                                <div class="danger-descriptions">
                                    <small class="clear-data-desc">Clear All Data: This action cannot be undone. All data including flashcards, quizzes, settings, statistics, user profile, and preferences will be permanently deleted.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner">
                <i class="fas fa-brain fa-spin"></i>
                <p>Loading...</p>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Duplicate import modal removed - was causing file dialog conflicts -->

        <!-- Clear Data Confirmation Modal -->
        <div class="modal" id="clear-data-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>
                        <i class="fas fa-exclamation-triangle"></i>
                        Confirm Clear All Data</h2>
                    <span class="close" onclick="app.uiManager.closeModal('clear-data-modal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="warning-message">
                        <p>
                            <strong>⚠️ Warning: This action cannot be undone!</strong>
                        </p>
                        <p>You are about to permanently delete:</p>
                        <ul>
                            <li>All flashcards and decks</li>
                            <li>All study progress and statistics</li>
                            <li>All custom settings</li>
                        </ul>
                        <p>Are you sure you want to continue?</p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="app.uiManager.closeModal('clear-data-modal')" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="button" onclick="app.dataManager.confirmClearAllData()" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                            Yes, Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- Enhanced Import Analysis Modal -->
        <div id="import-modal" class="modal" style="display: none;" aria-modal="true" role="dialog" aria-labelledby="importModalTitle">
            <div class="modal-content import-analysis-modal">
                <div class="modal-header">
                    <h3 id="importModalTitle">
                        <i class="fas fa-file-import"></i>
                        Import Analysis &amp; Preview
                    </h3>
                    <button class="modal-close" onclick="window.app.uiManager.closeModal('import-modal')" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- File Information Section -->
                    <div class="import-file-info">
                        <h4><i class="fas fa-file-alt"></i> File Information</h4>
                        <div class="file-info-grid">
                            <div class="info-item">
                                <span class="info-label">File Name:</span>
                                <span class="info-value" id="modal-file-name">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">File Size:</span>
                                <span class="info-value" id="modal-file-size">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Data Type:</span>
                                <span class="info-value" id="modal-data-type">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Created:</span>
                                <span class="info-value" id="modal-created-date">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content Analysis Section -->
                    <div class="import-content-analysis">
                        <h4><i class="fas fa-chart-pie"></i> Content Analysis</h4>
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <div class="card-icon flashcards">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <div class="card-content">
                                    <div class="card-number" id="modal-flashcards-count">0</div>
                                    <div class="card-label">Flashcards</div>
                                    <div class="card-details" id="modal-flashcards-details">-</div>
                                </div>
                            </div>
                            <div class="analysis-card">
                                <div class="card-icon quizzes">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="card-content">
                                    <div class="card-number" id="modal-quizzes-count">0</div>
                                    <div class="card-label">Quizzes</div>
                                    <div class="card-details" id="modal-quizzes-details">-</div>
                                </div>
                            </div>
                            <div class="analysis-card">
                                <div class="card-icon decks">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="card-content">
                                    <div class="card-number" id="modal-decks-count">0</div>
                                    <div class="card-label">Decks</div>
                                    <div class="card-details" id="modal-decks-details">-</div>
                                </div>
                            </div>
                            <div class="analysis-card">
                                <div class="card-icon settings">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <div class="card-content">
                                    <div class="card-number" id="modal-settings-count">0</div>
                                    <div class="card-label">Settings</div>
                                    <div class="card-details" id="modal-settings-details">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conflict Detection Section -->
                    <div class="import-conflicts" id="conflicts-section" style="display: none;">
                        <h4><i class="fas fa-exclamation-triangle"></i> Conflicts Detected</h4>
                        <div class="conflicts-summary">
                            <div class="conflict-item">
                                <span class="conflict-count" id="flashcard-conflicts">0</span>
                                <span class="conflict-label">Flashcard conflicts</span>
                            </div>
                            <div class="conflict-item">
                                <span class="conflict-count" id="quiz-conflicts">0</span>
                                <span class="conflict-label">Quiz conflicts</span>
                            </div>
                        </div>
                        <div class="conflicts-details" id="conflicts-details">
                            <!-- Conflict details will be populated here -->
                        </div>
                    </div>

                    <!-- Import Mode Selection -->
                    <div class="import-mode-selection">
                        <h4><i class="fas fa-cogs"></i> Import Mode</h4>
                        <div class="mode-options">
                            <div class="mode-option">
                                <input type="radio" id="replace-mode" name="import-mode" value="replace" checked>
                                <label for="replace-mode" class="mode-label">
                                    <div class="mode-icon replace">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div class="mode-content">
                                        <div class="mode-title">Replace All Data</div>
                                        <div class="mode-description">Replace all existing data with imported data. This will permanently delete your current data.</div>
                                    </div>
                                </label>
                            </div>
                            <div class="mode-option">
                                <input type="radio" id="append-mode" name="import-mode" value="append">
                                <label for="append-mode" class="mode-label">
                                    <div class="mode-icon append">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    <div class="mode-content">
                                        <div class="mode-title">Append &amp; Merge</div>
                                        <div class="mode-description">Add imported data to existing data. Conflicts will be resolved intelligently.</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Import Preview -->
                    <div class="import-preview">
                        <h4><i class="fas fa-eye"></i> Import Preview</h4>
                        <div class="preview-tabs">
                            <button class="preview-tab active" data-tab="flashcards">Flashcards</button>
                            <button class="preview-tab" data-tab="quizzes">Quizzes</button>
                            <button class="preview-tab" data-tab="settings">Settings</button>
                        </div>
                        <div class="preview-content">
                            <div class="preview-panel active" id="preview-flashcards">
                                <div class="preview-list" id="flashcards-preview-list">
                                    <!-- Flashcard previews will be populated here -->
                                </div>
                            </div>
                            <div class="preview-panel" id="preview-quizzes">
                                <div class="preview-list" id="quizzes-preview-list">
                                    <!-- Quiz previews will be populated here -->
                                </div>
                            </div>
                            <div class="preview-panel" id="preview-settings">
                                <div class="preview-list" id="settings-preview-list">
                                    <!-- Settings previews will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.app.eventHandler.cancelModalImport()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="execute-import-btn" onclick="window.app.eventHandler.executeImport()">
                        <i class="fas fa-download"></i>
                        Execute Import
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Results Modal -->
        <div id="importResultsModal" class="modal-overlay" style="display: none;" aria-modal="true" role="dialog" aria-labelledby="importResultsTitle">
            <div class="modal-content import-results-modal">
                <div class="modal-header">
                    <h3 id="importResultsTitle">
                        <i class="fas fa-check-circle text-success"></i>
                        Import Results
                    </h3>
                    <button class="modal-close" onclick="closeImportResultsModal()" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Progress Section -->
                    <div class="import-progress-section">
                        <div class="progress-header">
                            <h4>Import Progress</h4>
                            <span class="progress-percentage" id="import-progress-percentage">100%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="import-progress-bar" style="width: 100%;"></div>
                        </div>
                        <div class="progress-status" id="import-progress-status">Import completed successfully!</div>
                    </div>

                    <!-- File Summary Section -->
                    <div class="file-summary-section">
                        <h4>File Summary</h4>
                        <div class="file-details">
                            <div class="file-detail-item">
                                <i class="fas fa-file"></i>
                                <span class="detail-label">File Name:</span>
                                <span class="detail-value" id="result-file-name">-</span>
                            </div>
                            <div class="file-detail-item">
                                <i class="fas fa-weight"></i>
                                <span class="detail-label">File Size:</span>
                                <span class="detail-value" id="result-file-size">-</span>
                            </div>
                            <div class="file-detail-item">
                                <i class="fas fa-file-code"></i>
                                <span class="detail-label">File Type:</span>
                                <span class="detail-value" id="result-file-type">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Import Summary Section -->
                    <div class="import-summary-section">
                        <h4>Import Summary</h4>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <i class="fas fa-layer-group text-primary"></i>
                                <div class="stat-content">
                                    <span class="stat-number" id="imported-flashcards">0</span>
                                    <span class="stat-label">Flashcards</span>
                                </div>
                            </div>
                            <div class="summary-stat">
                                <i class="fas fa-question-circle text-info"></i>
                                <div class="stat-content">
                                    <span class="stat-number" id="imported-quizzes">0</span>
                                    <span class="stat-label">Quizzes</span>
                                </div>
                            </div>
                            <div class="summary-stat">
                                <i class="fas fa-cog text-warning"></i>
                                <div class="stat-content">
                                    <span class="stat-number" id="imported-settings">0</span>
                                    <span class="stat-label">Settings</span>
                                </div>
                            </div>
                            <div class="summary-stat">
                                <i class="fas fa-chart-bar text-success"></i>
                                <div class="stat-content">
                                    <span class="stat-number" id="imported-stats">0</span>
                                    <span class="stat-label">Statistics</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Validation Results Section -->
                    <div class="validation-results-section">
                        <h4>Validation Results</h4>
                        <div class="validation-summary">
                            <div class="validation-item success" id="validation-success" style="display: none;">
                                <i class="fas fa-check-circle"></i>
                                <span class="validation-text">All data validated successfully</span>
                            </div>
                            <div class="validation-item warning" id="validation-warnings" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="validation-text">Some warnings detected</span>
                                <div class="validation-details" id="warning-details"></div>
                            </div>
                            <div class="validation-item error" id="validation-errors" style="display: none;">
                                <i class="fas fa-times-circle"></i>
                                <span class="validation-text">Errors found during import</span>
                                <div class="validation-details" id="error-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeImportResultsModal()">
                        <i class="fas fa-check"></i>
                        Done
                    </button>
                </div>
            </div>
        </div>

        <!-- CSS Modules -->
        <link rel="stylesheet" href="../css/custom-checkbox.css">
        
        <!-- Footer -->
        <div id="footer-container"></div>

    <!-- Local Storage Authentication System -->
    <script src="../js/theme-manager.js"></script>
    
    <!-- JavaScript Modules - Load in order -->
    <script src="../js/navbar-loader.js"></script>
    <script src="../js/footer-loader.js"></script>
    <script src="../js/custom-checkbox.js"></script>
    <script src="../js/custom-dropdown.js"></script>
    <script src="../js/user-manager.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/flashcard-manager.js"></script>
    <script src="../js/quiz-manager.js"></script>
    <script src="../js/mixed-manager.js"></script>
    <script src="../js/content-manager.js"></script>
    <script src="../js/ui-manager.js"></script>
    <script src="../js/event-handler.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/main.js"></script>
    <script>
        console.log('Script block started');
        console.log('QuizWhizApp available:', typeof QuizWhizApp);
        
        // Cleanup existing app instance if it exists
        if (window.app && typeof window.app.cleanup === 'function') {
            console.log('Cleaning up existing app');
            window.app.cleanup();
        }
        
        // Initialize the main app instance
        console.log('Creating QuizWhizApp instance');
        try {
            window.app = new QuizWhizApp();
            console.log('QuizWhizApp created successfully:', window.app);
            console.log('App has eventHandler:', !!window.app.eventHandler);
        } catch (error) {
            console.error('Error creating QuizWhizApp:', error);
            console.error('Error stack:', error.stack);
        }
        
        // Initialize authentication guards after app is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure theme manager is initialized and auth guards are set up
            if (window.themeManager) {
                window.themeManager.setupAuthGuards();
            }
        });
    </script>
    <!-- <script src="../js/love-word-animation.js"></script> -->

</body>
</html>